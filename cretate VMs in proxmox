#!/usr/bin/env bash
# Creates 40 Kali VMs from template 9000 with users kali1..kali40 and password 'kali'

TEMPLATE_VMID=9000
START_VMID=100           # first VMID to use (100..139)
COUNT=26
NAME_PREFIX="kali"
STORAGE="local-lvm"      # change if your template/storage is different
BRIDGE="vmbr0"
CORES=2
MEM=2048                 # MB
DEFAULT_PASSWORD="kali"

# sanity check
qm config "$TEMPLATE_VMID" >/dev/null || { echo "Template $TEMPLATE_VMID missing"; exit 1; }

for i in $(seq 1 "$COUNT"); do
  VMID=$((START_VMID + i - 1))
  USERNAME="${NAME_PREFIX}${i}"         # kali1..kali40
  VMNAME="${NAME_PREFIX}-${i}"

  echo "=== Creating VM $VMID ($VMNAME) ==="
  qm clone "$TEMPLATE_VMID" "$VMID" --name "$VMNAME" --storage "$STORAGE" --full 1 || exit 2
  qm set "$VMID" --cores "$CORES" --memory "$MEM" --net0 virtio,bridge="$BRIDGE" --agent 1
  qm set "$VMID" --ciuser "$USERNAME" --cipassword "$DEFAULT_PASSWORD"
  # start the VM
  qm start "$VMID"
  sleep 2
done

echo "Done: created $COUNT VMs starting at VMID $START_VMID."
